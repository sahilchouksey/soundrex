{"version":3,"file":"react-intersection-observer-hook.cjs.development.js","sources":["../src/utils.ts","../src/useIntersectionObserver.ts","../src/useTrackVisibility.ts"],"sourcesContent":["type EntryCallback = (entry: IntersectionObserverEntry) => void;\n\ntype CachedObserver = {\n  observer: IntersectionObserver;\n  entryCallbacks: Map<Element, EntryCallback>;\n};\n\ntype ObserverCache = Map<string, CachedObserver>;\n\ntype ObserverCachesByRoot = Map<\n  IntersectionObserverInit['root'],\n  ObserverCache\n>;\n\nexport type CachedIntersectionObserver = {\n  observe: (\n    node: Element,\n    callback: (entry: IntersectionObserverEntry) => void,\n  ) => void;\n  unobserve: (node: Element) => void;\n};\n\nexport function createObserverCache() {\n  const cachesByRoot: ObserverCachesByRoot = new Map();\n\n  function getObserver({\n    root,\n    rootMargin,\n    threshold,\n  }: IntersectionObserverInit): CachedIntersectionObserver {\n    let cacheByRoot = cachesByRoot.get(root);\n\n    if (!cacheByRoot) {\n      cacheByRoot = new Map();\n      cachesByRoot.set(root, cacheByRoot);\n    }\n\n    const cacheKey = JSON.stringify({ rootMargin, threshold });\n    let cachedObserver = cacheByRoot.get(cacheKey);\n\n    if (!cachedObserver) {\n      const entryCallbacks = new Map<Element, EntryCallback>();\n\n      const observer = new IntersectionObserver(\n        (entries) => {\n          entries.forEach((entry) => {\n            const callback = entryCallbacks.get(entry.target);\n            callback?.(entry);\n          });\n        },\n        { root, rootMargin, threshold },\n      );\n\n      cachedObserver = { observer, entryCallbacks };\n\n      cacheByRoot.set(cacheKey, cachedObserver);\n    }\n\n    return {\n      observe: (\n        node: Element,\n        callback: (entry: IntersectionObserverEntry) => void,\n      ) => {\n        cachedObserver?.entryCallbacks.set(node, callback);\n        cachedObserver?.observer.observe(node);\n      },\n      unobserve: (node: Element) => {\n        cachedObserver?.entryCallbacks.delete(node);\n        cachedObserver?.observer.unobserve(node);\n      },\n    };\n  }\n\n  return { getObserver };\n}\n","import { useState, useCallback, useRef } from 'react';\nimport { CachedIntersectionObserver, createObserverCache } from './utils';\nimport { Omit } from './types';\n\nconst DEFAULT_ROOT_MARGIN = '0px';\nconst DEFAULT_THRESHOLD = [0];\n\nexport type IntersectionObserverHookArgs = Omit<\n  IntersectionObserverInit,\n  'root'\n>;\n\nexport type IntersectionObserverHookRefCallbackNode = Element | null;\n\nexport type IntersectionObserverHookRefCallback = (\n  node: IntersectionObserverHookRefCallbackNode,\n) => void;\n\nexport type IntersectionObserverHookRootRefCallbackNode = IntersectionObserverInit['root'];\n\nexport type IntersectionObserverHookRootRefCallback = (\n  node: IntersectionObserverHookRootRefCallbackNode,\n) => void;\n\nexport type IntersectionObserverHookResult = [\n  IntersectionObserverHookRefCallback,\n  {\n    entry: IntersectionObserverEntry | undefined;\n    rootRef: IntersectionObserverHookRootRefCallback;\n  },\n];\n\nconst observerCache = createObserverCache();\n\n// For more info:\n// https://developers.google.com/web/updates/2016/04/intersectionobserver\n// https://developer.mozilla.org/en-US/docs/Web/API/Intersection_Observer_API\nfunction useIntersectionObserver(\n  args?: IntersectionObserverHookArgs,\n): IntersectionObserverHookResult {\n  const rootMargin = args?.rootMargin ?? DEFAULT_ROOT_MARGIN;\n  const threshold = args?.threshold ?? DEFAULT_THRESHOLD;\n\n  const nodeRef = useRef<IntersectionObserverHookRefCallbackNode>(null);\n  const rootRef = useRef<IntersectionObserverHookRootRefCallbackNode>(null);\n  const observerRef = useRef<CachedIntersectionObserver | null>(null);\n\n  const [entry, setEntry] = useState<IntersectionObserverEntry>();\n\n  const observe = useCallback(() => {\n    const node = nodeRef.current;\n\n    if (!node) {\n      setEntry(undefined);\n      return;\n    }\n\n    const observer = observerCache.getObserver({\n      root: rootRef.current,\n      rootMargin,\n      threshold,\n    });\n\n    observer.observe(node, (observedEntry) => {\n      setEntry(observedEntry);\n    });\n\n    observerRef.current = observer;\n  }, [rootMargin, threshold]);\n\n  const unobserve = useCallback(() => {\n    const currentObserver = observerRef.current;\n    const node = nodeRef.current;\n\n    if (node) {\n      currentObserver?.unobserve(node);\n    }\n\n    observerRef.current = null;\n  }, []);\n\n  // React will call the ref callback with the DOM element when the component mounts,\n  // and call it with null when it unmounts.\n  // So, we don't need an useEffect etc to unobserve nodes.\n  // When nodeRef.current is null, it will be unobserved and observe function\n  // won't do anything.\n  const refCallback = useCallback<IntersectionObserverHookRefCallback>(\n    (node) => {\n      unobserve();\n      nodeRef.current = node;\n      observe();\n    },\n    [observe, unobserve],\n  );\n\n  const rootRefCallback = useCallback<IntersectionObserverHookRootRefCallback>(\n    (rootNode) => {\n      unobserve();\n      rootRef.current = rootNode;\n      observe();\n    },\n    [observe, unobserve],\n  );\n\n  return [refCallback, { entry, rootRef: rootRefCallback }];\n}\n\nexport default useIntersectionObserver;\n","import { useState } from 'react';\nimport useIntersectionObserver, {\n  IntersectionObserverHookArgs,\n  IntersectionObserverHookResult,\n} from './useIntersectionObserver';\n\nexport type TrackVisibilityHookArgs = IntersectionObserverHookArgs;\n\nexport type TrackVisibilityHookResult = [\n  IntersectionObserverHookResult[0],\n  IntersectionObserverHookResult[1] & {\n    isVisible: boolean;\n    wasEverVisible: boolean;\n  },\n];\n\nfunction useTrackVisibility(\n  args?: IntersectionObserverHookArgs,\n): TrackVisibilityHookResult {\n  const [ref, result] = useIntersectionObserver(args);\n  const isVisible = Boolean(result.entry?.isIntersecting);\n  const [wasEverVisible, setWasEverVisible] = useState(isVisible);\n\n  if (isVisible && !wasEverVisible) {\n    setWasEverVisible(true);\n  }\n\n  return [ref, { ...result, isVisible, wasEverVisible }];\n}\n\nexport default useTrackVisibility;\n"],"names":["createObserverCache","cachesByRoot","Map","getObserver","root","rootMargin","threshold","cacheByRoot","get","set","cacheKey","JSON","stringify","cachedObserver","entryCallbacks","observer","IntersectionObserver","entries","forEach","entry","callback","target","observe","node","unobserve","DEFAULT_ROOT_MARGIN","DEFAULT_THRESHOLD","observerCache","useIntersectionObserver","args","nodeRef","useRef","rootRef","observerRef","useState","setEntry","useCallback","current","undefined","observedEntry","currentObserver","refCallback","rootRefCallback","rootNode","useTrackVisibility","ref","result","isVisible","Boolean","isIntersecting","wasEverVisible","setWasEverVisible"],"mappings":"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"}